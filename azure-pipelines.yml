trigger:
- none
pool: MQ

stages:
- stage:
  displayName: stage1
  jobs:
  - job: TerraformInitPlan
    displayName: Job1
    
    pool: MQ
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'


    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'Workload fed MI'
        backendAzureRmStorageAccountName: 'mqstorage3'
        backendAzureRmContainerName: 'mq123'
        backendAzureRmKey: 'key.tfstate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/Parent'
        
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(System.DefaultWorkingDirectory)/Parent'

-  stage:
   displayName: stage2
   jobs:
   - job: TerraformInitPlanStage2
     displayName: Job2
     pool: MQ
     steps:
      
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/Parent'
          backendServiceArm: 'Workload fed MI'
          backendAzureRmStorageAccountName: 'mqstorage3'
          backendAzureRmContainerName: 'mq123'
          backendAzureRmKey: 'key.tfstate'   

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          workingDirectory: '$(System.DefaultWorkingDirectory)/Parent'
          environmentServiceNameAzureRM: 'Workload fed MI'
