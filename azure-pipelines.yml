trigger:
- none
pool: MQ

stages:
- stage:
  displayName: stage1
  jobs:
  - job: TerraformInitPlan
    displayName: Job1
    
    pool: MQ
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraforminit
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendAzureRmUseEntraIdForAuthentication: false
        backendServiceArm: 'Workload identity MQ'
        backendAzureRmStorageAccountName: 'mqstorage3'
        backendAzureRmContainerName: 'mq123'
        backendAzureRmKey: 'key.tfstate'



    - task: TerraformTask@5
      displayName: Terraformvalidate
      inputs:
        provider: 'azurerm'
        command: 'validate'

  - job: TerraformValidate
    displayName: Job2
    pool: MQ
    
    steps:

    - task: TerraformTask@5
      displayName: Terraforminit
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendAzureRmUseEntraIdForAuthentication: false
        backendServiceArm: 'Workload identity MQ'
        backendAzureRmStorageAccountName: 'mqstorage3'
        backendAzureRmContainerName: 'mq123'
        backendAzureRmKey: 'key.tfstate'
    - task: TerraformTask@5
      displayName: Terraformplan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'Workload identity MQ'




- stage:
  displayName: stage2
  jobs:
  - job: TerraformInitPlan
    displayName: Job1
    
    pool: MQ
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: Terraforminit
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendAzureRmUseEntraIdForAuthentication: false
        backendServiceArm: 'Workload identity MQ'
        backendAzureRmStorageAccountName: 'mqstorage3'
        backendAzureRmContainerName: 'mq123'
        backendAzureRmKey: 'key.tfstate'



    - task: TerraformTask@5
      displayName: Terraformvalidate
      inputs:
        provider: 'azurerm'
        command: 'validate'

  - job: TerraformValidate
    displayName: Job2
    pool: MQ
    
    steps:

    - task: TerraformTask@5
      displayName: Terraforminit
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendAzureRmUseEntraIdForAuthentication: false
        backendServiceArm: 'Workload identity MQ'
        backendAzureRmStorageAccountName: 'mqstorage3'
        backendAzureRmContainerName: 'mq123'
        backendAzureRmKey: 'key.tfstate'
    - task: TerraformTask@5
      displayName: Terraformplan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: 'Workload identity MQ'

    - task: TerraformTask@5
      displayName: "Terraform apply"
      inputs:
        provider: 'azurerm'
        command: 'apply'
        environmentServiceNameAzureRM: 'Workload identity MQ'
